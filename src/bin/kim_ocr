#!/bin/bash
#
# Copyright (C) 2013  Daniel Tartavel <contact@librepc.com>
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, U
#
# Author : Daniel Tartavel <contact@librepc.com>

export TEXTDOMAIN="kim"
export TEXTDOMAINDIR="/usr/share/locale"
. gettext.sh

FILE="";
let "nbfiles = $# "

test -n "$KDEHOME" || KDEHOME="`kde4-config --localprefix`"; export KDEHOME
TMPDIR=`mktemp -d "$KDEHOME"/tmp-"$HOSTNAME"/kim.XXXXXXXX` || exit 1
echo $TMPDIR
title=`gettext "Kim Convert to text"`
init=`gettext "Initializing"`
label=`gettext "Converting file :"`
dbusRef=`kdialog --geometry "300x50" --title "$title" --progressbar "$init" $nbfiles`
qdbus  $dbusRef showCancelButton true

compteur=0
for i in "$@";do
	if [ -f "$i" ];then
		#test if cancel button has been pushed
		if test "true" = `qdbus  $dbusRef wasCancelled`;then
			qdbus  $dbusRef close
			exit 1
		fi
		let "compteur +=1"
		qdbus  $dbusRef setLabelText "$label `basename "$FILE"`"
		FILE="$i"
		TMPFILE="$TMPDIR/`basename "${FILE%%.*}"`"
		#echo $TMPFILE
		convert $FILE -normalize "$TMPFILE.pgm"
		unpaper  "$TMPFILE.pgm" "$TMPDIR/unpaper.pgm"
		convert "$TMPDIR/unpaper.pgm" "$TMPFILE.tiff"
		qdbus  $dbusRef setLabelText `gettext "Character recognition"`
		tesseract "$TMPFILE.tiff" ${FILE%%.*} -l fra
 		qdbus  $dbusRef value $compteur
 		qdbus  $dbusRef showCancelButton true 		
	fi;
done
#rm -Rf $TMPDIR
qdbus  $dbusRef close
